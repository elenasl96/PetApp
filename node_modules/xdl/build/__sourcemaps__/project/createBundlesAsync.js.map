{"version":3,"sources":["project/createBundlesAsync.ts"],"names":["MINIMUM_BUNDLE_SIZE","printBundleSizes","bundles","files","ios","code","android","map","push","chalk","dim","logger","global","info","TableText","createFilesTable","createBundlesAsync","projectRoot","publishOptions","bundleOptions","useDevServer","options","nonPersistent","maxWorkers","target","reset","resetCache","verbose","quiet","fetchPublishBundlesAsync","isLegacy","skipSDKVersionRequirement","exp","platforms","ProjectUtils","getLogger","platform","entryPoint","dev","opts","publishUrl","UrlUtils","constructPublishUrlAsync","undefined","sourceMapUrl","constructSourceMapUrlAsync","assetsUrl","constructAssetsUrlAsync","iosBundle","_getForPlatformAsync","errorCode","minLength","androidBundle","iosSourceMap","androidSourceMap","iosAssetsJson","androidAssetsJson","assets","JSON","parse","url","fullUrl","response","axios","request","responseType","transformResponse","data","proxy","validateStatus","status","headers","error","body","e","logError","message","XDLError","length"],"mappings":"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","sourcesContent":["import { getConfig, isLegacyImportsEnabled, Platform } from '@expo/config';\nimport { bundleAsync, BundleOutput } from '@expo/dev-server';\nimport axios from 'axios';\nimport chalk from 'chalk';\n\nimport { ErrorCode } from '../ErrorCode';\nimport logger from '../Logger';\nimport * as UrlUtils from '../UrlUtils';\nimport XDLError from '../XDLError';\nimport * as TableText from '../logs/TableText';\nimport { learnMore } from '../logs/TerminalLink';\nimport {\n  startReactNativeServerAsync,\n  stopReactNativeServerAsync,\n} from '../start/startLegacyReactNativeServerAsync';\nimport { resolveEntryPoint } from '../tools/resolveEntryPoint';\nimport * as ProjectUtils from './ProjectUtils';\nimport { PublishOptions } from './getPublishExpConfigAsync';\n\nconst MINIMUM_BUNDLE_SIZE = 500;\n\ntype PackagerOptions = {\n  dev: boolean;\n  minify: boolean;\n};\n\nexport function printBundleSizes(bundles: { android: BundleOutput; ios: BundleOutput }) {\n  const files = [\n    ['index.ios.js', bundles.ios.code],\n    ['index.android.js', bundles.android.code],\n  ];\n  // Account for inline source maps\n  if (bundles.ios.map) {\n    files.push([chalk.dim('index.ios.js.map'), bundles.ios.map]);\n  }\n  if (bundles.android.map) {\n    files.push([chalk.dim('index.android.js.map'), bundles.android.map]);\n  }\n\n  logger.global.info('');\n  logger.global.info(TableText.createFilesTable(files));\n  logger.global.info('');\n  logger.global.info(\n    `ðŸ’¡ JavaScript bundle sizes affect startup time. ${chalk.dim(\n      learnMore(`https://expo.fyi/javascript-bundle-sizes`)\n    )}`\n  );\n  logger.global.info('');\n}\n\nexport async function createBundlesAsync(\n  projectRoot: string,\n  publishOptions: PublishOptions = {},\n  bundleOptions: { dev?: boolean; useDevServer: boolean }\n): Promise<{ android: BundleOutput; ios: BundleOutput }> {\n  if (!bundleOptions.useDevServer) {\n    try {\n      await startReactNativeServerAsync({\n        projectRoot,\n        options: {\n          nonPersistent: true,\n          maxWorkers: publishOptions.maxWorkers,\n          target: publishOptions.target,\n          reset: publishOptions.resetCache,\n        },\n        verbose: !publishOptions.quiet,\n      });\n      return await fetchPublishBundlesAsync(projectRoot);\n    } finally {\n      await stopReactNativeServerAsync(projectRoot);\n    }\n  }\n\n  const isLegacy = isLegacyImportsEnabled(\n    getConfig(projectRoot, { skipSDKVersionRequirement: true }).exp\n  );\n  // If not legacy, delete the target option to prevent warnings from being thrown.\n  if (!isLegacy) {\n    delete publishOptions.target;\n  }\n  const platforms: Platform[] = ['android', 'ios'];\n  const [android, ios] = await bundleAsync(\n    projectRoot,\n    {\n      target: publishOptions.target,\n      resetCache: publishOptions.resetCache,\n      logger: ProjectUtils.getLogger(projectRoot),\n      quiet: publishOptions.quiet,\n    },\n    platforms.map((platform: Platform) => ({\n      platform,\n      entryPoint: resolveEntryPoint(projectRoot, platform),\n      dev: bundleOptions.dev,\n    }))\n  );\n\n  return {\n    android,\n    ios,\n  };\n}\n\n// Fetch iOS and Android bundles for publishing\nasync function fetchPublishBundlesAsync(projectRoot: string, opts?: PackagerOptions) {\n  const entryPoint = resolveEntryPoint(projectRoot);\n  const publishUrl = await UrlUtils.constructPublishUrlAsync(\n    projectRoot,\n    entryPoint,\n    undefined,\n    opts\n  );\n  const sourceMapUrl = await UrlUtils.constructSourceMapUrlAsync(projectRoot, entryPoint);\n  const assetsUrl = await UrlUtils.constructAssetsUrlAsync(projectRoot, entryPoint);\n\n  logger.global.info('Building iOS bundle');\n  const iosBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building Android bundle');\n  const androidBundle = await _getForPlatformAsync(projectRoot, publishUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building source maps');\n  const iosSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'ios', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n  const androidSourceMap = await _getForPlatformAsync(projectRoot, sourceMapUrl, 'android', {\n    errorCode: 'INVALID_BUNDLE',\n    minLength: MINIMUM_BUNDLE_SIZE,\n  });\n\n  logger.global.info('Building asset maps');\n  const iosAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'ios', {\n    errorCode: 'INVALID_ASSETS',\n  });\n  const androidAssetsJson = await _getForPlatformAsync(projectRoot, assetsUrl, 'android', {\n    errorCode: 'INVALID_ASSETS',\n  });\n\n  return {\n    android: { code: androidBundle, map: androidSourceMap, assets: JSON.parse(androidAssetsJson) },\n    ios: { code: iosBundle, map: iosSourceMap, assets: JSON.parse(iosAssetsJson) },\n  };\n}\n\nasync function _getForPlatformAsync(\n  projectRoot: string,\n  url: string,\n  platform: Platform,\n  { errorCode, minLength }: { errorCode: ErrorCode; minLength?: number }\n): Promise<string> {\n  const fullUrl = `${url}&platform=${platform}`;\n  let response;\n\n  try {\n    response = await axios.request({\n      url: fullUrl,\n      responseType: 'text',\n      // Workaround for https://github.com/axios/axios/issues/907.\n      // Without transformResponse, axios will parse the body as JSON regardless of the responseType/\n      transformResponse: [data => data],\n      proxy: false,\n      validateStatus: status => status === 200,\n      headers: {\n        'Exponent-Platform': platform,\n      },\n    });\n  } catch (error) {\n    if (error.response) {\n      if (error.response.data) {\n        let body;\n        try {\n          body = JSON.parse(error.response.data);\n        } catch (e) {\n          ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n        }\n\n        if (body) {\n          if (body.message) {\n            ProjectUtils.logError(projectRoot, 'expo', body.message);\n          } else {\n            ProjectUtils.logError(projectRoot, 'expo', error.response.data);\n          }\n        }\n      }\n      throw new XDLError(\n        errorCode,\n        `Packager URL ${fullUrl} returned unexpected code ${error.response.status}. ` +\n          'Please open your project in the Expo app and see if there are any errors. ' +\n          'Also scroll up and make sure there were no errors or warnings when opening your project.'\n      );\n    } else {\n      throw error;\n    }\n  }\n\n  if (!response.data || (minLength && response.data.length < minLength)) {\n    throw new XDLError(errorCode, `Body is: ${response.data}`);\n  }\n\n  return response.data;\n}\n"],"file":"../../project/createBundlesAsync.js","sourceRoot":"/xdl@59.0.27/src"}